---
title: "Exploratory Data Analysis, Evaluation, and Visualization"
format: html
editor: visual
---

```{r}
# Libraries
library(tidyverse)
library(stm)
library(glue)

# Data Cleaning Scripts
source('r/1__dataPreparation.R')

# Modeling Scripts
source('r/2__modelCreationAndSelection.R')

# Data Capture Scripts
source('r/rUtils/dataCapture/apis.R')

# Data Profiling
source('r/rUtils/EDA.R')

```

# Exploratory Data Analysis of 311 Calls

We're attempting to use 311 calls as a test bed for use of STM. To that end, we want to ensure we have good understanding of our underlying data.

## Capture Data

We'll look at 6 months worth of data pulled from our public 311 calls.\

```{r}

# Capture 311 Calls
data__311Calls <- getData_cartoDbMonthQuery(
                       baseQuery = "SELECT * FROM public_cases_fc WHERE CLOSED_DATETIME >= "
                       , monthsOfData = 6
                       )
```

Lets profile the data so we know what we're looking at. This code is pulled from the rUtils EDA.R

```{r}
simpleEdaScript(data__311Calls)

```

We have 294871 total calls -- none are NA, which isn't really believable.

```{r}
data__311Calls %>% group_by(status_notes) %>% summarize( count = n()) %>% arrange(-count)

print(data__311Calls %>% sapply(. %>% is.na %>% sum()))

```

Lets find the most suitable agency for analysis on -- we're looking for something with a lot of data, and a lot of distinct subject

```{r}


```

Lets explore the 311 agency

```{r}
targets::tar_read('extract__311raw') %>% 
  filter(agency_responsible == 'Philly311 Contact Center') %>% 
  mutate(totalCalls = n()) %>% 
  group_by(subject) %>% mutate(subjectCount = n()) %>% 
  ungroup() %>% 
  mutate(subjectPercentOfTotal = subjectCount / totalCalls) %>% 
  select(subject,subjectPercentOfTotal,subjectCount,totalCalls) %>% 
  arrange(-subjectCount) %>% 
  unique ()

```

## Evaluating Models

## Visualizing A Test Model

```{r}
#| fig-height: 20

plot.STM(
    targets::tar_read('model')
  , type = 'labels'
)


```
